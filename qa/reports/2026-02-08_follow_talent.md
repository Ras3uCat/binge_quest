# QA Report: Follow Talent (Actors & Directors)

**Date:** 2026-02-08
**Feature:** Follow Talent
**Status:** PASS (Code Review + Bug Fixes Applied)

---

## Environment

- **Flutter Version:** 3.32.5 (stable)
- **Dart Version:** 3.8.1
- **Platform:** Linux (6.18.7-zen1-1-zen)
- **Supabase:** ffodlqpscvabcguzbqif (us-east-1, PostgreSQL 17)
- **Runtime Testing:** Not performed (code review only)

---

## Summary

Full code review of 13 files (8 new, 3 modified, 1 migration, 1 Edge Function). Found 1 critical bug and 1 medium issue, both fixed before report finalization.

---

## Backend Verification

| Component | Status |
|-----------|--------|
| `followed_talent` table (RLS, indexes, constraints) | LIVE |
| `talent_content_events` table (RLS, indexes, constraints) | LIVE |
| `get_followed_persons_to_check` RPC | LIVE |
| `get_followers_of_person` RPC | LIVE |
| `check-talent-content` Edge Function v2 | ACTIVE |
| `send-notification` integration (category: talent_releases) | VERIFIED |
| Security advisors — no new warnings | VERIFIED |

---

## Bugs Found & Fixed

### BUG-1 (CRITICAL) — String-to-int type mismatch [FIXED]

**Problem:** Edge Function sent `tmdb_id` and `person_id` as `String()` in notification data. Frontend cast them as `int?`, causing `TypeError` at runtime — breaking notification taps, deep links, and quick-add.

**Files affected:**
- `talent_notification_card.dart` (3 occurrences)
- `notifications_screen.dart` (2 occurrences)

**Fix:** Changed all `data['tmdb_id'] as int?` to `int.tryParse(data['tmdb_id']?.toString() ?? '')`. Handles both string and int values from JSONB.

### ISS-3 (MEDIUM) — Missing content_title in notification data [FIXED]

**Problem:** Edge Function did not include `content_title` in the notification `data` map. Quick-add flow showed "Content" instead of actual title.

**Fix:** Added `content_title: contentTitle` to the Edge Function data payload. Redeployed as v2. Frontend fallback changed from `'Content'` to `notification.title`.

---

## File Review Results

| File | Lines | Pattern | Verdict |
|------|-------|---------|---------|
| `shared/models/followed_talent.dart` | 46 | PASS | PASS |
| `shared/models/talent_content_event.dart` | 48 | PASS | PASS |
| `shared/repositories/followed_talent_repository.dart` | 87 | PASS | PASS |
| `profile/controllers/followed_talent_controller.dart` | 133 | PASS | PASS |
| `shared/widgets/follow_talent_button.dart` | 110 | PASS | PASS |
| `profile/widgets/following_section.dart` | 237 | PASS | PASS |
| `notifications/widgets/talent_notification_card.dart` | 266 | PASS | PASS (after fix) |
| `notifications/helpers/quick_add_helper.dart` | 122 | PASS | PASS |
| `notifications/screens/notifications_screen.dart` | 173 | PASS | PASS (after fix) |
| `search/screens/person_detail_screen.dart` | 572 | >300 | PRE-EXISTING |
| `profile/screens/profile_screen.dart` | 371 | >300 | PRE-EXISTING |
| `migrations/031_follow_talent.sql` | 128 | PASS | PASS |
| `functions/check-talent-content/index.ts` | 235 | PASS | PASS (after fix) |

---

## Pre-existing Line Count Violations (not introduced by this feature)

- `person_detail_screen.dart`: 572 lines (was 554 before, +18 for follow button)
- `profile_screen.dart`: 371 lines (was 367 before, +4 for following section)

Both files exceeded 300 lines before this feature. Recommend refactoring in a future cleanup pass.

---

## QA Checklist (from feature spec)

| Scenario | Code Review | Runtime |
|----------|-------------|---------|
| Can follow/unfollow actor from content detail | EXPECTED PASS | NOT TESTED |
| Can follow/unfollow director from content detail | EXPECTED PASS | NOT TESTED |
| Following list displays on profile | EXPECTED PASS | NOT TESTED |
| Notification received when new content detected | EXPECTED PASS | NOT TESTED |
| Tapping notification shows content detail | EXPECTED PASS (after BUG-1 fix) | NOT TESTED |
| Unfollowing stops future notifications | EXPECTED PASS | NOT TESTED |

---

## Recommendations

### Immediate
1. Manual runtime test: `cd execution/frontend/flutter && flutter run -d chrome`
2. Test follow/unfollow flow on a person detail screen
3. Verify Following section renders on profile

### Future
- Refactor `person_detail_screen.dart` (extract `_CreditCard` widget)
- Refactor `profile_screen.dart` (extract stat/action builders)
- Add widget tests for `FollowTalentButton` toggle behavior
- Set up cron schedule for `check-talent-content` Edge Function

---

*Report generated by QA Agent*
